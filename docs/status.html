<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fonseware Server Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="res/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container" id="main-view">
    <h1 style="font-family: 'InstrumentSerif-Regular';">fonseware.com status</h1>
    <p class="tagline">keeping you updated on server availability</p>

    <div id="status" class="status">loading status...</div>
    <div id="timestamp" class="timestamp"></div>

    </br>
    <h2 style="margin-top: 2rem;">ðŸ“œ past downtime incidents</h2>
    </br>
    <div id="incident-list" class="incident-list"></div>
    <footer style="margin-top: 3rem;">
      status auto-refreshes every 5 seconds 
    </br></br>
      &copy; 2025 fonseware
    </footer>
  </div>

  <!-- rendered markdown view -->
  <div class="container" id="incident-view" style="display: none;">
    <button class="incident-button" onclick="goBack()" style="margin-bottom: 1rem;">&larr; back</button>
    <div id="incident-content" class="incident-content"></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const timestampEl = document.getElementById('timestamp');
    const incidentListEl = document.getElementById('incident-list');
    const mainView = document.getElementById('main-view');
    const incidentView = document.getElementById('incident-view');
    const incidentContent = document.getElementById('incident-content');

    async function checkStatus() {
      try {
        const res = await fetch('https://fonseware.com/ping.txt', { cache: 'no-store' });
        const text = await res.text();
        const now = new Date().toLocaleTimeString();

        if (text.trim().toLowerCase() === 'pong') {
          statusEl.textContent = 'ðŸŸ¢ fonseware.com is ONLINE';
          statusEl.style.color = 'green';
        } else {
          statusEl.textContent = 'ðŸ”´ fonseware.com is UNREACHABLE (unexpected response)';
          statusEl.style.color = 'red';
        }

        timestampEl.textContent = `last checked at: ${now}`;
      } catch (err) {
        const now = new Date().toLocaleTimeString();
        statusEl.textContent = 'ðŸ”´ fonseware.com is OFFLINE (cannot connect)';
        statusEl.style.color = 'red';
        timestampEl.textContent = `last checked at: ${now}`;
      }
    }

    checkStatus();
    setInterval(checkStatus, 5000);

    async function loadIncidents() {
      try {
        const res = await fetch("events/index.json");
        const files = await res.json();

        if (files.length === 0) {
          incidentListEl.textContent = "there are no past incidents";
          return;
        }

        files.forEach(file => {
          const btn = document.createElement('button');
          btn.textContent = file.replace('.md', '');
          btn.onclick = () => loadIncident(file);
          btn.style.display = "block";
          btn.style.margin = "10px auto";
          incidentListEl.appendChild(btn);
        });
      } catch (err) {
        incidentListEl.textContent = "error loading incident history";
      }
    }

    async function loadIncident(file) {
      try {
        const res = await fetch(`events/${file}`);
        const md = await res.text();
        const html = marked.parse(md);

        incidentContent.innerHTML = html;
        mainView.style.display = "none";
        incidentView.style.display = "block";
      } catch (err) {
        incidentContent.innerHTML = "<p style='color:red;'>failed to load incident</p>";
      }
    }

    function goBack() {
      incidentView.style.display = "none";
      mainView.style.display = "block";
    }

    loadIncidents();
  </script>
</body>
</html>
