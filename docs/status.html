<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>fonseware server status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="res/styles.css"/>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" type="image/x-icon" href="res/favicon.png"/>
</head>
<body>
<div class="container" id="main-view">
    <img src="res/logo.png" alt="logo" width="400px"/>
    <h1
            style="
          font-family: 'instrumentserif-regular';
        "
    >
        fonseware webserver status
    </h1>

    <!-- Status Card -->
    <div class="card">
        <div id="status" class="status">loading status...</div>
        <div id="timestamp" class="timestamp"></div>
        <p class="timestamp">status auto-refreshes every 5 seconds.</p>

        go to <a href="https://www.fonseware.com/">fonseware.com</a>.
    </div>

    <!-- Past Incidents Card -->
    <div class="card">
        <h2>ðŸ“œ past downtime incidents</h2>
        <div id="incident-list" class="incident-list"></div>
    </div>

    <div class="card">
        <p class="tagline" style="text-align: left">
            <strong style="font-family: 'instrumentserif-regular';" class="topics">
                what and why is this page here?
            </strong><br>
            my website runs on a home-hosted webserver. sometimes it goes offline for maintenance or when my computer
            needs a break.
            any unusual issues or interruptions while the server is running will be reported here.
            normal planned downtime (like updates or restarts) might not be listed.

        </p>
    </div>

    <footer>
        &copy; 2025 fonseware. all rights reserved.
        <br> This fallback site is hosted on github pages and is <a href="https://github.com/fonseware/fallback">open
        source</a>, but does not accept any pull requests.
    </footer>
</div>

<!-- Rendered Markdown View -->
<div class="container" id="incident-view" style="display: none">
    <button class="incident-button" onclick="goBack()">&larr; back</button>
    <div id="incident-content" class="incident-content"></div>
</div>

<script>
    const statusEl = document.getElementById("status");
    const timestampEl = document.getElementById("timestamp");
    const incidentListEl = document.getElementById("incident-list");
    const mainView = document.getElementById("main-view");
    const incidentView = document.getElementById("incident-view");
    const incidentContent = document.getElementById("incident-content");

    async function checkStatus() {
        try {
            const res = await fetch("https://fonseware.com/ping.txt", {
                cache: "no-store",
            });
            const text = await res.text();
            const now = new Date().toLocaleTimeString();

            if (text.trim().toLowerCase() === "pong") {
                statusEl.textContent = "ðŸŸ¢ fonseware.com is online";
                statusEl.style.color = "green";
            } else {
                statusEl.textContent =
                    "ðŸ”´ fonseware.com is unreachable (unexpected response)";
                statusEl.style.color = "red";
            }

            timestampEl.textContent = `last checked at: ${now}`;
        } catch (err) {
            const now = new Date().toLocaleTimeString();
            statusEl.textContent = "ðŸ”´ fonseware.com is offline (cannot connect)";
            statusEl.style.color = "red";
            timestampEl.textContent = `last checked at: ${now}`;
        }
    }

    checkStatus();
    setInterval(checkStatus, 5000);

    async function loadIncidents() {
        try {
            const res = await fetch("events/index.json");
            const files = await res.json();

            if (files.length === 0) {
                incidentListEl.textContent = "there are no past downtime incidents";
                return;
            }

            files.forEach((file) => {
                const btn = document.createElement("button");
                btn.textContent = file.replace(".md", "");
                btn.onclick = () => loadIncident(file);
                incidentListEl.appendChild(btn);
            });
        } catch (err) {
            incidentListEl.textContent = "error loading incident history";
        }
    }

    async function loadIncident(file) {
        try {
            const res = await fetch(`events/${file}`);
            const md = await res.text();
            const html = marked.parse(md);

            incidentContent.innerHTML = html;
            mainView.style.display = "none";
            incidentView.style.display = "block";
        } catch (err) {
            incidentContent.innerHTML =
                "<p style='color:red;'>failed to load incidents</p>";
        }
    }

    function goBack() {
        incidentView.style.display = "none";
        mainView.style.display = "block";
    }

    loadIncidents();
</script>
</body>
</html>
