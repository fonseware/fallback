<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>fonseware server status</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="res/styles.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="res/favicon.png" rel="icon" type="image/x-icon"/>
</head>
<body>
<div class="container" id="main-view">
    <img alt="logo" src="res/logo.png" width="400"/>
    <h1
            style="
          font-family: 'instrumentserif-regular';
        "
    >
        fonseware webserver status
    </h1>
    <p class="tagline">this is the status page for <a href="https://www.fonseware.com/">fonseware.com</a></p>
    <!-- Status Card -->
    <div class="card">
        <div class="status" id="status">contacting server...</div>
        <div class="timestamp" id="timestamp"></div>
        <p class="tagline" style="margin-bottom: -5px">status auto-refreshes every 5 seconds.</p>
    </div>

    <!-- Past Incidents Card -->
    <div class="card">
        <h2 class="topics tagline" style="font-family: 'instrumentserif-regular';">ðŸ“œ past downtime incidents</h2>
        <div class="incident-list tagline" id="incident-list" style="margin-bottom: -5px"></div>
    </div>

    <div class="card">
        <p class="tagline" style="text-align: left">
            <strong class="topics" style="font-family: 'instrumentserif-regular';">
                what and why is this page here?
            </strong><br>
            my website runs on a home-hosted webserver. sometimes it goes offline for maintenance or when my computer
            needs a break.
            any unusual issues or interruptions while the server is running will be reported here.
            normal planned downtime (like updates or restarts) might not be listed.
        </p>
    </div>

    <footer class="tagline">
        &copy; 2025 fonseware. all rights reserved.
        <br> This fallback site is hosted on <a href="https://pages.github.com/">GitHub Pages</a> and is <a
            href="https://github.com/fonseware/fallback">open
        source</a>, but does not accept any pull requests.
    </footer>
</div>

<!-- Rendered Markdown View -->
<div class="container" id="incident-view" style="display: none">
    <button class="incident-button" onclick="goBack()">&larr; back</button>
    <div class="incident-content" id="incident-content"></div>
</div>

<script>
    const statusEl = document.getElementById("status");
    const timestampEl = document.getElementById("timestamp");
    const incidentListEl = document.getElementById("incident-list");
    const mainView = document.getElementById("main-view");
    const incidentView = document.getElementById("incident-view");
    const incidentContent = document.getElementById("incident-content");

    async function checkStatus() {
        try {
            const res = await fetch("https://fonseware.com/ping.txt", {
                cache: "no-store",
            });
            const text = await res.text();
            const now = new Date().toLocaleTimeString();

            if (text.trim().toLowerCase() === "pong") {
                statusEl.textContent = "ðŸŸ¢ all systems operational";
                statusEl.style.color = "green";
            } else {
                statusEl.textContent =
                    "ðŸŸ  partial outage (unexpected response)";
                statusEl.style.color = "orange";
            }

            timestampEl.textContent = `last checked at: ${now}`;
        } catch (err) {
            const now = new Date().toLocaleTimeString();
            statusEl.textContent = "ðŸ”´ major outage (cannot connect)";
            statusEl.style.color = "red";
            timestampEl.textContent = `last checked at: ${now}`;
        }
    }

    checkStatus();
    setInterval(checkStatus, 5000);

    async function loadIncidents() {
        try {
            const res = await fetch("events/index.json");
            const files = await res.json();

            if (files.length === 0) {
                incidentListEl.textContent = "there are no past downtime incidents";
                return;
            }

            files.forEach((file) => {
                const btn = document.createElement("button");
                btn.textContent = file.replace(".md", "");
                btn.onclick = () => loadIncident(file);
                incidentListEl.appendChild(btn);
            });
        } catch (err) {
            incidentListEl.textContent = "error loading incident history";
        }
    }

    async function loadIncident(file) {
        try {
            const res = await fetch(`events/${file}`);
            const md = await res.text();
            const html = marked.parse(md);

            incidentContent.innerHTML = html;
            mainView.style.display = "none";
            incidentView.style.display = "block";
        } catch (err) {
            incidentContent.innerHTML =
                "<p style='color:red;'>failed to load incidents</p>";
        }
    }

    function goBack() {
        incidentView.style.display = "none";
        mainView.style.display = "block";
    }

    loadIncidents();
</script>
</body>
</html>
